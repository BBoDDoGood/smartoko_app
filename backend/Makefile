# SmartOkO Backend Makefile
# ì‹¤ë¬´ì—ì„œ ì‚¬ìš©í•˜ëŠ” í‘œì¤€ ëª…ë ¹ì–´ë“¤

.PHONY: help dev staging prod install test clean

# ê¸°ë³¸ ëª…ë ¹ì–´ (make ë§Œ ì…ë ¥ì‹œ ë„ì›€ë§ í‘œì‹œ)
help:
	@echo "ğŸš€ SmartOkO Backend ëª…ë ¹ì–´"
	@echo ""
	@echo "ê°œë°œ ê´€ë ¨:"
	@echo "  make dev      - ê°œë°œí™˜ê²½ ì„œë²„ ì‹¤í–‰"
	@echo "  make staging  - ìŠ¤í…Œì´ì§•í™˜ê²½ ì„œë²„ ì‹¤í–‰"
	@echo "  make prod     - í”„ë¡œë•ì…˜í™˜ê²½ ì„œë²„ ì‹¤í–‰"
	@echo ""
	@echo "ì„¤ì¹˜ ë° ê´€ë¦¬:"
	@echo "  make install  - íŒ¨í‚¤ì§€ ì„¤ì¹˜"
	@echo "  make test     - í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
	@echo "  make clean    - ìºì‹œ íŒŒì¼ ì •ë¦¬" 

# ê°œë°œí™˜ê²½ ì‹¤í–‰
dev:
	@echo "ğŸš€ ê°œë°œí™˜ê²½ ì„œë²„ ì‹œì‘..."
	@echo "ğŸ“‹ í™˜ê²½: development"
	@echo "ğŸŒ ë¡œì»¬: http://127.0.0.1:8000"
	@echo "ğŸŒ ë„¤íŠ¸ì›Œí¬: http://$(shell ifconfig | grep "inet " | grep -v 127.0.0.1 | head -1 | awk '{print $$2}'):8000"
	@echo "ğŸ“– ë¬¸ì„œ: http://127.0.0.1:8000/api/docs"
	ENVIRONMENT=development uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# ìŠ¤í…Œì´ì§•í™˜ê²½ ì‹¤í–‰  
staging:
	@echo "ğŸš€ ìŠ¤í…Œì´ì§•í™˜ê²½ ì„œë²„ ì‹œì‘..."
	@echo "ğŸ“‹ í™˜ê²½: staging"
	@echo "ğŸŒ ì£¼ì†Œ: http://0.0.0.0:8000"
	@echo "ğŸ“– ë¬¸ì„œ: http://0.0.0.0:8000/api/docs"
	ENVIRONMENT=staging uvicorn app.main:app --host 0.0.0.0 --port 8000

# í”„ë¡œë•ì…˜í™˜ê²½ ì‹¤í–‰
prod:
	@echo "ğŸš€ í”„ë¡œë•ì…˜í™˜ê²½ ì„œë²„ ì‹œì‘..."
	@echo "ğŸ“‹ í™˜ê²½: production"
	@echo "ğŸŒ ì£¼ì†Œ: http://0.0.0.0:8000"
	@echo "âš ï¸  í”„ë¡œë•ì…˜ ëª¨ë“œ: API ë¬¸ì„œ ë¹„í™œì„±í™”ë¨"
	ENVIRONMENT=production uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4

# íŒ¨í‚¤ì§€ ì„¤ì¹˜
install:
	@echo "ğŸ“¦ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
	pip install -r requirements.txt

# í…ŒìŠ¤íŠ¸ ì‹¤í–‰
test:
	@echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	pytest tests/ -v

# ìºì‹œ ë° ì„ì‹œ íŒŒì¼ ì •ë¦¬
clean:
	@echo "ğŸ§¹ ì •ë¦¬ ì¤‘..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name ".pytest_cache" -delete

# Docker ê´€ë ¨ ëª…ë ¹ì–´
docker-build:
	@echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
	docker build -t smartoko-backend:latest .

docker-run:
	@echo "ğŸ³ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
	docker run -d \
		--name smartoko-backend \
		-p 8000:8000 \
		--env-file .env.docker \
		smartoko-backend:latest

docker-stop:
	@echo "ğŸ›‘ Docker ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
	docker stop smartoko-backend
	docker rm smartoko-backend

docker-logs:
	@echo "ğŸ“‹ Docker ë¡œê·¸ í™•ì¸..."
	docker logs -f smartoko-backend

# Docker Compose ëª…ë ¹ì–´
compose-up:
	@echo "ğŸš€ Docker Composeë¡œ ì „ì²´ ìŠ¤íƒ ì‹œì‘..."
	docker-compose up -d

compose-down:
	@echo "ğŸ›‘ Docker Compose ìŠ¤íƒ ì¤‘ì§€..."
	docker-compose down

compose-logs:
	@echo "ğŸ“‹ Docker Compose ë¡œê·¸ í™•ì¸..."
	docker-compose logs -f

compose-rebuild:
	@echo "ğŸ”¨ Docker Compose ì¬ë¹Œë“œ..."
	docker-compose up -d --build

# Docker ìƒíƒœ í™•ì¸
compose-status:
	@echo "ğŸ” Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸..."
	@docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

compose-check:
	@echo "ğŸ³ Docker ì „ì²´ ìƒíƒœ í™•ì¸..."
	@./check-docker.sh

compose-health:
	@echo "ğŸ¥ API í—¬ìŠ¤ì²´í¬..."
	@curl -s http://localhost:8000/health | python3 -m json.tool || echo "âŒ API ì‘ë‹µ ì—†ìŒ"